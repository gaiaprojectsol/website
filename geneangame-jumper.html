<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jump Game</title>
<style>
    body {
        background: #000;
        margin: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #0ff;
        font-family: Arial, sans-serif;
    }

    #container {
        text-align: center;
        width: 600px;
    }

    #game {
        width: 600px;
        height: 200px;
        background: #111;
        border: 2px solid #0ff;
        position: relative;
        overflow: hidden;
        margin-top: 20px;
    }

    #player {
        width: 40px;
        height: 40px;
        background: url("genean-run.png");
        background-size: cover;
        position: absolute;
        bottom: 0;
        left: 50px;
    }

    .obstacle {
        width: 20px;
        height: 40px;
        background: #f00;
        position: absolute;
        bottom: 0;
        right: -30px;
    }

    #score {
        position: absolute;
        top: 10px;
        left: 10px;
    }

    #game-over {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        font-size: 22px;
        color: #f00;
        text-align: center;
    }

    #overlay {
        margin-bottom: 20px;
    }

    #name-input {
        padding: 10px;
        font-size: 16px;
        border: 2px solid #0ff;
        background: #222;
        color: #0ff;
    }

    #start-btn {
        padding: 10px 20px;
        margin-left: 10px;
        font-size: 16px;
        cursor: pointer;
        background: #0ff;
        color: #000;
        border: none;
    }

    /* Submit panel */
    #submit-panel {
        display: none;
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #0ff;
        background: #111;
    }

    #submit-btn, #retry-btn {
        padding: 10px 20px;
        font-size: 15px;
        cursor: pointer;
        margin-top: 10px;
    }

    #submit-btn {
        background: #0ff;
        color: #000;
        border: none;
    }

    #retry-btn {
        background: #222;
        color: #0ff;
        border: 1px solid #0ff;
        display: none;
    }

    #submit-status {
        margin-top: 10px;
        font-size: 14px;
    }
</style>
</head>
<body>

<div id="container">

    <!-- START SCREEN -->
    <div id="overlay">
        <p>Enter your name to begin:</p>
        <input id="name-input" placeholder="Your name..." />
        <button id="start-btn">Start</button>
        <p style="margin-top:10px; font-size:14px; color:#0ff;">
            Press <b>SPACEBAR</b> to jump.
        </p>
    </div>

    <!-- GAME AREA -->
    <div id="game">
        <div id="player"></div>
        <div id="score">Score: 0</div>
        <div id="game-over">Game Over<br><small>Press Space to Restart</small></div>
    </div>

    <!-- SUBMIT PANEL -->
    <div id="submit-panel">
        <p>Submit your score to the Solana blockchain?</p>
        <p>Name: <span id="submit-name"></span></p>
        <p>Score: <span id="submit-score"></span></p>
        
        <button id="submit-btn">Send Memo</button>
        <button id="retry-btn">Retry</button>

        <p id="submit-status"></p>
    </div>

</div>

<!-- SOUND EFFECTS -->
<audio id="jump-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="death-sound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

<script>
    // Elements
    const game = document.getElementById("game");
    const player = document.getElementById("player");
    const scoreEl = document.getElementById("score");
    const gameOverEl = document.getElementById("game-over");

    const jumpSound = document.getElementById("jump-sound");
    const deathSound = document.getElementById("death-sound");

    const submitPanel = document.getElementById("submit-panel");
    const submitName = document.getElementById("submit-name");
    const submitScore = document.getElementById("submit-score");
    const submitBtn = document.getElementById("submit-btn");
    const retryBtn = document.getElementById("retry-btn");
    const submitStatus = document.getElementById("submit-status");

    // Game State
    let nameValue = "";
    let running = false;
    let alive = true;
    let jumping = false;

    let jumpVelocity = 0;
    const gravity = 0.5;
    let score = 0;

    // --- START SCREEN ---
    document.getElementById("start-btn").onclick = () => {
        const val = document.getElementById("name-input").value.trim();
        if (!val) {
            alert("Please enter your name.");
            return;
        }
        nameValue = val;
        document.getElementById("overlay").style.display = "none";
        startGame();
    };

    // --- CONTROLS ---
    document.addEventListener("keydown", e => {
        if (e.code === "Space") {
            if (!running) return;
            if (!alive) resetGame();
            else jump();
        }
    });

    function jump() {
        if (!alive || jumping) return;
        jumping = true;
        jumpVelocity = 10;
        jumpSound.play();
    }

    // --- GAME START ---
    function startGame() {
        running = true;
        update();
        spawnObstacle();
    }

    function spawnObstacle() {
        if (!alive) return;

        const obs = document.createElement("div");
        obs.classList.add("obstacle");
        game.appendChild(obs);

        let speed = 5;

        function move() {
            if (!alive) return;

            obs.style.left = obs.offsetLeft - speed + "px";

            if (obs.offsetLeft < -40) {
                obs.remove();
                return;
            }

            if (checkCollision(player, obs)) {
                alive = false;
                deathSound.play();
                gameOverEl.style.display = "block";

                setTimeout(() => showSubmitPanel(nameValue, score), 600);
                return;
            }

            requestAnimationFrame(move);
        }

        move();
        setTimeout(spawnObstacle, 1000 + Math.random() * 700);
    }

    function checkCollision(a, b) {
        const r1 = a.getBoundingClientRect();
        const r2 = b.getBoundingClientRect();

        return !(
            r1.top > r2.bottom ||
            r1.bottom < r2.top ||
            r1.right < r2.left ||
            r1.left > r2.right
        );
    }

    function update() {
        if (jumping) {
            let bottom = parseInt(player.style.bottom || 0);
            bottom += jumpVelocity;
            jumpVelocity -= gravity;

            if (bottom <= 0) {
                bottom = 0;
                jumping = false;
            }

            player.style.bottom = bottom + "px";
        }

        if (alive) {
            score++;
            scoreEl.textContent = "Score: " + score;
        }

        if (running) requestAnimationFrame(update);
    }

    // --- RESET GAME ---
    function resetGame() {
        document.querySelectorAll(".obstacle").forEach(o => o.remove());

        alive = true;
        jumping = false;
        score = 0;

        player.style.bottom = "0px";
        gameOverEl.style.display = "none";
        scoreEl.textContent = "Score: 0";

        submitPanel.style.display = "none";

        update();
        spawnObstacle();
    }

    // --- SUBMIT PANEL ---
    function showSubmitPanel(name, score) {
        submitName.textContent = name;
        submitScore.textContent = score;
        submitStatus.textContent = "";
        retryBtn.style.display = "none";
        submitPanel.style.display = "block";

        submitBtn.onclick = () => handleMemoSubmit(name, score);
        retryBtn.onclick = () => handleMemoSubmit(name, score);
    }

    // --- SEND MEMO ---
async function handleMemoSubmit(name, score) {
    submitStatus.style.color = "#0ff";
    submitStatus.textContent = "Sending to Solana...";

    try {
        if (!window.solana?.isPhantom) {
            submitStatus.style.color = "#f00";
            submitStatus.textContent = "Phantom Wallet required.";
            return;
        }

        // Ensure Phantom is connected
        const provider = window.solana;
        const resp = await provider.connect(); 
        const publicKey = resp.publicKey;

        // Connect to Helius RPC
        const connection = new solanaWeb3.Connection(
            "https://mainnet.helius-rpc.com/?api-key=d616d97c-62dc-4962-b859-54861377cd5b"
        );

        // Build memo program instruction
        const memoProgram = new solanaWeb3.PublicKey(
            "MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"
        );

        const recorderWallet = new solanaWeb3.PublicKey(
            "BvM4csixHBdcxpxy4w2bQ21WUfymdk9EjSuWrEz4uev3"
        );

        const memoData = JSON.stringify({
            type: "gaia-score",
            name,
            score,
            ts: Date.now()
        });

        const encodedMemo = new TextEncoder().encode(memoData);

        const instruction = new solanaWeb3.TransactionInstruction({
            keys: [{ pubkey: recorderWallet, isSigner: false, isWritable: false }],
            programId: memoProgram,
            data: encodedMemo
        });

        // Build transaction
        const tx = new solanaWeb3.Transaction().add(instruction);

        // REQUIRED: Fee payer + blockhash
        const blockhash = await connection.getLatestBlockhash();

        tx.feePayer = publicKey;
        tx.recentBlockhash = blockhash.blockhash;

        // Phantom signs it
        const signedTx = await provider.signTransaction(tx);

        // Submit raw transaction
        const sig = await connection.sendRawTransaction(
            signedTx.serialize(),
            { skipPreflight: false }
        );

        submitStatus.style.color = "#0f0";
        submitStatus.innerHTML =
            `Score recorded!<br><a href="https://solscan.io/tx/${sig}" target="_blank" style="color:#0ff;">View Transaction</a>`;
        retryBtn.style.display = "none";

    } catch (err) {
        console.error(err);
        submitStatus.style.color = "#f00";
        submitStatus.textContent = "Failed to send memo. Please try again.";
        retryBtn.style.display = "inline-block";
    }
}

</script>

</body>
</html>
