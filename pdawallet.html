<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solana Wallet Cashflow Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background: #0a0a0a;
    color: white;
    font-family: Arial, sans-serif;
    padding: 20px;
  }
  h1, h2 { text-align: center; }
  table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
  }
  th, td {
    border: 1px solid #444;
    padding: 8px;
  }
  th {
    background: #222;
  }
  input.note {
    width: 95%;
    padding: 5px;
    background: #222;
    border: 1px solid #555;
    color: #fff;
    border-radius: 4px;
  }
</style>
</head>
<body>

<h1>Solana Historical Cashflow</h1>
<p id="status">Loading historical data...</p>

<table>
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Change (SOL)</th>
      <th>From / To</th>
      <th>Balance After</th>
      <th>Note</th>
    </tr>
  </thead>
  <tbody id="ledger"></tbody>
</table>

<script>

const WALLET = "7qeCuMQUVhxfncxddC3A1SYQQJnDhxJBBcrxhKDzfbs";
const RPC = "https://mainnet.helius-rpc.com/?api-key=d616d97c-62dc-4962-b859-54861377cd5b";

let notes = JSON.parse(localStorage.getItem("cashflowNotes") || "{}");
function saveNotes() { localStorage.setItem("cashflowNotes", JSON.stringify(notes)); }

async function fetchHistory() {
  const txs = await fetch(RPC, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      jsonrpc: "2.0",
      id: 1,
      method: "getSignaturesForAddress",
      params: [WALLET, { limit: 1000 }]
    })
  }).then(r => r.json());

  return txs.result;
}

async function fetchTxDetails(signature) {
  const res = await fetch(RPC, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      jsonrpc: "2.0",
      id: 1,
      method: "getTransaction",
      params: [signature, { encoding: "jsonParsed" }]
    })
  }).then(r => r.json());

  return res.result;
}

async function buildHistoricalLedger() {
  document.getElementById("status").innerText = "Fetching transactions...";

  const sigs = await fetchHistory();
  let rows = [];

  for (const sigObj of sigs) {
    const tx = await fetchTxDetails(sigObj.signature);
    if (!tx || !tx.meta) continue;

    const keys = tx.transaction.message.accountKeys.map(k => k.pubkey);
    const walletIndex = keys.indexOf(WALLET);

    // If the wallet isn't involved in balance changes, skip
    if (walletIndex === -1) continue;

    const pre = tx.meta.preBalances[walletIndex] / 1e9;
    const post = tx.meta.postBalances[walletIndex] / 1e9;
    const change = post - pre;

    // Skip zero-value transactions
    if (change === 0) continue;

    const timestamp = new Date(tx.blockTime * 1000).toLocaleString();
    const rowId = sigObj.signature;

    rows.push({
      id: rowId,
      timestamp,
      change,
      balance: post,
      from: keys[0],
      to: keys[1]
    });
  }

  renderRows(rows.reverse());
  document.getElementById("status").innerText = "Loaded.";
}

function renderRows(rows) {
  const ledger = document.getElementById("ledger");
  ledger.innerHTML = "";

  for (const r of rows) {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${r.timestamp}</td>
      <td style="color:${r.change > 0 ? "lightgreen":"red"};">
        ${r.change.toFixed(4)}
      </td>
      <td>
        From: ${r.from}<br>
        To: ${r.to}
      </td>
      <td>${r.balance.toFixed(4)}</td>
      <td>
        <input class="note" id="note-${r.id}" placeholder="Add noteâ€¦" value="${notes[r.id] || ""}">
      </td>
    `;

    tr.querySelector("input").addEventListener("input", (e) => {
      notes[r.id] = e.target.value;
      saveNotes();
    });

    ledger.appendChild(tr);
  }
}

buildHistoricalLedger();

</script>

</body>
</html>
