<script type="module">
  import bs58 from "https://esm.sh/bs58@5.0.0";

  const RPC_URL = "https://mainnet.helius-rpc.com/?api-key=d616d97c-62dc-4962-b859-54861377cd5b";
  const MEMO_PROGRAM_ID = "MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr";

  async function rpcCall(method, params) {
    const res = await fetch(RPC_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        jsonrpc: "2.0",
        id: 1,
        method,
        params
      })
    });

    const json = await res.json();
    if (json.error) {
      throw new Error(json.error.message || "RPC error");
    }
    return json.result;
  }

  function decodeMemoData(data) {
    if (typeof data !== "string") return null;
    try {
      const bytes = bs58.decode(data);
      return new TextDecoder().decode(bytes);
    } catch (e) {
      console.error("Failed to decode memo data", e);
      return null;
    }
  }

  function extractMemosFromTransaction(tx) {
    const memos = [];
    if (!tx || !tx.transaction || !tx.transaction.message) return memos;

    const message = tx.transaction.message;
    const accountKeys = message.accountKeys || [];

    // Legacy top-level instructions
    if (Array.isArray(message.instructions)) {
      for (const inst of message.instructions) {
        const programId = accountKeys[inst.programIdIndex];
        if (programId === MEMO_PROGRAM_ID) {
          const memo = decodeMemoData(inst.data);
          if (memo !== null) memos.push(memo);
        }
      }
    }

    // Inner instructions (Helius)
    if (tx.meta && Array.isArray(tx.meta.innerInstructions)) {
      for (const inner of tx.meta.innerInstructions) {
        if (!inner.instructions) continue;
        for (const inst of inner.instructions) {
          const programId = accountKeys[inst.programIdIndex];
          if (programId === MEMO_PROGRAM_ID) {
            const memo = decodeMemoData(inst.data);
            if (memo !== null) memos.push(memo);
          }
        }
      }
    }

    return memos;
  }

  window.readWalletMemos = async function () {
    const wallet = document.getElementById("wallet").value.trim();
    const output = document.getElementById("output");
    output.innerHTML = "Loading...";

    if (!wallet) {
      output.innerHTML = "‚ùå Please enter a wallet address.";
      return;
    }

    try {
      const signatures = await rpcCall("getSignaturesForAddress", [
        wallet,
        { limit: 30 }
      ]);

      if (!signatures || signatures.length === 0) {
        output.innerHTML = "<p>No transactions found for this address.</p>";
        return;
      }

      const results = [];

      for (const sig of signatures) {
        const tx = await rpcCall("getTransaction", [
          sig.signature,
          { encoding: "json", maxSupportedTransactionVersion: 0 }
        ]);

        if (!tx) continue;

        const memos = extractMemosFromTransaction(tx);
        if (memos.length === 0) continue;

        // ‚≠ê Sender = fee payer (always accountKeys[0])
        const sender =
          tx.transaction.message.accountKeys?.[0] || "Unknown";

        results.push({
          sender,
          memos
        });
      }

      if (results.length === 0) {
        output.innerHTML = "<p>No memo transactions found for this address.</p>";
        return;
      }

      output.innerHTML = "<h2>üìú Memo Transactions:</h2>";
      for (const r of results) {
        const memoHtml = r.memos
          .map(m => `<div>${m}</div>`)
          .join("");

        output.innerHTML += `
          <div class="memo-card">
            <p><strong>Sender:</strong><br>${r.sender}</p>
            <p><strong>Memo:</strong><br>${memoHtml}</p>
          </div>
        `;
      }

    } catch (err) {
      console.error(err);
      output.innerHTML = "‚ùå Error: " + err.message;
    }
  };
</script>
