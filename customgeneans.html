<script type="module">
  import * as solanaWeb3 from "https://esm.sh/@solana/web3.js@1.95.3";
  import bs58 from "https://esm.sh/bs58@5.0.0";

  window.readWalletMemos = async function () {
    const wallet = document.getElementById("wallet").value.trim();
    const output = document.getElementById("output");
    output.innerHTML = "Loading...";

    try {
      const connection = new solanaWeb3.Connection(
        "https://mainnet.helius-rpc.com/?api-key=d616d97c-62dc-4962-b859-54861377cd5b",
        "confirmed"
      );

      const pubkey = new solanaWeb3.PublicKey(wallet);

      const signatures = await connection.getSignaturesForAddress(pubkey, {
        limit: 50
      });

      let results = [];

      for (let sig of signatures) {

        const tx = await connection.getTransaction(sig.signature, {
          maxSupportedTransactionVersion: 0
        });

        if (!tx) continue;

        const memoProgram = "MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr";

        /* -----------------------------------------
           ‚≠ê 1. CHECK TOP-LEVEL INSTRUCTIONS
        ----------------------------------------- */

        let message = tx.transaction.message;
        let accountKeys =
          message.accountKeys ?? message.staticAccountKeys ?? [];

        let instructions =
          message.instructions ?? message.compiledInstructions ?? [];

        for (let inst of instructions) {
          const programId = accountKeys[inst.programIdIndex];
          if (!programId) continue;

          if (programId.toBase58() === memoProgram) {
            const memoBytes = bs58.decode(inst.data);
            const memo = new TextDecoder().decode(memoBytes);

            results.push({
              signature: sig.signature,
              memo,
              time: tx.blockTime
            });
          }
        }

        /* -----------------------------------------
           ‚≠ê 2. CHECK meta.innerInstructions (Helius!
           This is where YOUR memo is located)
        ----------------------------------------- */

        if (tx.meta && tx.meta.innerInstructions) {
          for (let inner of tx.meta.innerInstructions) {
            for (let inst of inner.instructions) {
              try {
                const programId = accountKeys[inst.programIdIndex];
                if (!programId) continue;

                if (programId.toBase58() === memoProgram) {
                  // Helius sometimes returns base58 + sometimes raw bytes
                  let memo;

                  if (typeof inst.data === "string") {
                    const memoBytes = bs58.decode(inst.data);
                    memo = new TextDecoder().decode(memoBytes);
                  } else {
                    memo = new TextDecoder().decode(inst.data);
                  }

                  results.push({
                    signature: sig.signature,
                    memo,
                    time: tx.blockTime
                  });
                }
              } catch {}
            }
          }
        }
      }

      if (results.length === 0) {
        output.innerHTML = "<p>No memo transactions found.</p>";
        return;
      }

      output.innerHTML = "<h2>üìú Memo Transactions:</h2>";

      results.forEach(r => {
        const date = r.time
          ? new Date(r.time * 1000).toUTCString()
          : "Unknown";

        output.innerHTML += `
          <div class="memo-card">
            <p><strong>Memo:</strong> ${r.memo}</p>
            <p><strong>Signature:</strong><br>
              <a href="https://explorer.solana.com/tx/${r.signature}">
                ${r.signature}
              </a>
            </p>
            <p><strong>Time:</strong> ${date}</p>
          </div>
        `;
      });

    } catch (err) {
      output.innerHTML = "‚ùå Error: " + err.message;
    }
  };
</script>
