<script type="module">
  import * as solanaWeb3 from "https://esm.sh/@solana/web3.js@1.95.3";
  import bs58 from "https://esm.sh/bs58@5.0.0";

  window.readWalletMemos = async function () {
    const wallet = document.getElementById("wallet").value.trim();
    const output = document.getElementById("output");
    output.innerHTML = "Loading...";

    try {
      const connection = new solanaWeb3.Connection(
        "https://mainnet.helius-rpc.com/?api-key=d616d97c-62dc-4962-b859-54861377cd5b",
        "confirmed"
      );

      const pubkey = new solanaWeb3.PublicKey(wallet);

      const signatures = await connection.getSignaturesForAddress(pubkey, {
        limit: 50
      });

      let results = [];

      for (let sig of signatures) {
        const tx = await connection.getTransaction(sig.signature, {
          maxSupportedTransactionVersion: 0
        });

        if (!tx) continue;

        const message = tx.transaction.message;

        // ‚≠ê Handle BOTH legacy + v0 instructions
        const instructions =
          message.instructions ?? message.compiledInstructions ?? [];

        // ‚≠ê Handle BOTH legacy + v0 account key formats
        const accountKeys =
          message.accountKeys ?? message.staticAccountKeys;

        const memoProgram = "MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr";

        for (let inst of instructions) {
          const programId = accountKeys[inst.programIdIndex];
          if (!programId) continue;

          if (programId.toBase58() === memoProgram) {
            // ‚≠ê Fix for base58-encoded memo data
            const memoBytes = bs58.decode(inst.data);
            const memo = new TextDecoder().decode(memoBytes);

            results.push({
              signature: sig.signature,
              memo: memo,
              time: tx.blockTime
            });
          }
        }
      }

      if (results.length === 0) {
        output.innerHTML = "<p>No memo transactions found.</p>";
        return;
      }

      output.innerHTML = "<h2>üìú Memo Transactions:</h2>";

      results.forEach(r => {
        const date = r.time
          ? new Date(r.time * 1000).toUTCString()
          : "Unknown";
        output.innerHTML += `
          <div class="memo-card">
            <p><strong>Memo:</strong> ${r.memo}</p>
            <p><strong>Signature:</strong><br>
              <a href="https://explorer.solana.com/tx/${r.signature}">
                ${r.signature}
              </a>
            </p>
            <p><strong>Time:</strong> ${date}</p>
          </div>
        `;
      });

    } catch (err) {
      output.innerHTML = "‚ùå Error: " + err.message;
    }
  };
</script>
