<!-- 1Ô∏è‚É£ Load the Buffer polyfill -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>

<!-- 2Ô∏è‚É£ Wait until it finishes, then define global Buffer and dynamically load web3.js -->
<script>
  window.addEventListener('load', () => {
    if (window.buffer && window.buffer.Buffer) {
      window.Buffer = window.buffer.Buffer;
    } else {
      console.error('Buffer polyfill failed to load');
    }

    const script = document.createElement('script');
    script.src = 'https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.js';
    script.onload = initApp;     // run main logic only after web3.js finishes
    document.head.appendChild(script);
  });

  function initApp() {
    console.log('‚úÖ web3.js loaded and Buffer is ready');

    const statusEl   = document.getElementById("status");
    const sendBtn    = document.getElementById("sendBtn");
    const RECIPIENT  = new solanaWeb3.PublicKey("7qeCuMQUVhxfncxddC3A1SYQ4JnDhxJBBcrxhKDzfbs");
    const LAMPORTS   = 0.1 * solanaWeb3.LAMPORTS_PER_SOL;
    const MEMO_PROGRAM_ID = new solanaWeb3.PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr");

    if ("solana" in window && (window.solana.isPhantom || window.phantom?.solana?.isPhantom)) {
      statusEl.textContent = "üü¢ Phantom detected ‚Äî enter a memo and click Send.";
    } else {
      statusEl.innerHTML =
        '‚ùå Phantom not detected. <a href="https://phantom.app/download" target="_blank" style="color:#00ff99;">Install here</a>.';
      return;
    }

    sendBtn.onclick = async () => {
      try {
        const provider = window.phantom?.solana || window.solana;
        if (!provider?.isPhantom) throw new Error("Phantom wallet not found");

        const resp = await provider.request({ method: "connect" });
        const pubKey = provider.publicKey?.toString() || resp.publicKey?.toString();
        if (!pubKey) throw new Error("Failed to connect to Phantom");
        statusEl.textContent = "‚úÖ Connected: " + pubKey;

        const connection = new solanaWeb3.Connection(
          solanaWeb3.clusterApiUrl("mainnet-beta"), "confirmed"
        );

        const memoText = document.getElementById("memoInput").value.trim() || "Gaia supporter";

        const memoIx = new solanaWeb3.TransactionInstruction({
          keys: [],
          programId: MEMO_PROGRAM_ID,
          data: Buffer.from(memoText, "utf8"),
        });

        const transferIx = solanaWeb3.SystemProgram.transfer({
          fromPubkey: provider.publicKey,
          toPubkey:   RECIPIENT,
          lamports:   LAMPORTS,
        });

        const tx = new solanaWeb3.Transaction().add(transferIx, memoIx);
        tx.feePayer = provider.publicKey;
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

        const signed = await provider.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        await connection.confirmTransaction(sig, "confirmed");

        statusEl.innerHTML =
          `‚úÖ Sent 0.1 SOL to ${RECIPIENT.toBase58()}<br>`+
          `üìù Memo: ${memoText}<br>`+
          `<a href="https://solscan.io/tx/${sig}" target="_blank">View on Solscan</a>`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "‚ùå " + (err.message || "Transaction failed.");
      }
    };
  }
</script>
